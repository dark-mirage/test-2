"use client";

import React, { useEffect, useState } from "react";
import Link from "next/link";
import { usePathname } from "next/navigation";

import { cn } from "@/lib/format/cn";
import styles from "./Footer.module.css";

const CART_STORAGE_KEY = "loyaltymarket_cart_v1";
const CART_UPDATED_EVENT = "loyaltymarket_cart_updated";

function getCartTotalQuantityFromStorage() {
  try {
    const raw = localStorage.getItem(CART_STORAGE_KEY);
    if (!raw) return 0;

    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) return 0;

    return parsed.reduce((sum, entry) => {
      const x = typeof entry === "object" && entry !== null ? entry : {};
      const q = typeof x.quantity === "number" ? x.quantity : 0;
      return sum + Math.max(0, q);
    }, 0);
  } catch {
    return 0;
  }
}

function IconHome({ filled, className }) {
  return (
    <svg
      width="25"
      height="23"
      viewBox="0 0 25 23"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
      className={className}
      aria-hidden="true"
      focusable="false"
    >
      <path
        d="M2.8313 9.4801V19.8088C2.8313 20.1245 2.95368 20.4272 3.17152 20.6504C3.38936 20.8736 3.68481 20.999 3.99289 20.999H8.63923C8.9473 20.999 9.24276 20.8736 9.4606 20.6504C9.67844 20.4272 9.80082 20.1245 9.80082 19.8088V15.2823C9.80082 14.9667 9.9232 14.664 10.141 14.4407C10.3589 14.2175 10.6543 14.0922 10.9624 14.0922H13.2856C13.5936 14.0922 13.8891 14.2175 14.1069 14.4407C14.3248 14.664 14.4472 14.9667 14.4472 15.2823V19.8088C14.4472 20.1245 14.5695 20.4272 14.7874 20.6504C15.0052 20.8736 15.3007 20.999 15.6087 20.999H20.2551C20.5632 20.999 20.8586 20.8736 21.0765 20.6504C21.2943 20.4272 21.4167 20.1245 21.4167 19.8088V9.4801"
        stroke="currentColor"
        strokeWidth="2.14252"
        fill={filled ? "currentColor" : "none"}
      />
      <path
        d="M23.0713 10.8192L12.3643 1.26156C12.1974 1.11255 11.9452 1.11255 11.7783 1.26156L1.07129 10.8192"
        stroke="currentColor"
        strokeWidth="2.14252"
        strokeLinecap="round"
        fill={filled ? "currentColor" : "none"}
      />
    </svg>
  );
}

function IconPoizon({ filled, className }) {
  return (
    <svg
      width="15"
      height="17"
      viewBox="0 0 15 17"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
      className={className}
      aria-hidden="true"
      focusable="false"
    >
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M2 9.088V17H3.48911H5.11091V16.5998C5.1429 16.4443 5.11091 15.5593 5.11091 13.5004V10.31L6.8246 10.1902C9.45618 10 10.4383 9.66683 11.6461 9.088C12.5813 8.63986 13.1734 8.07499 13.5239 7.3275C14.1978 5.89036 13.9833 4.15943 13.388 2.68802C12.6977 0.98186 11.4274 0.305076 8.68309 0.0750926C8.03641 0.0209871 6.27761 -0.011223 4.77473 0.00361528H2V9.088ZM7.85609 1.09118C9.04698 1.30543 9.78758 1.8289 10.4383 2.97821C10.8314 4.0006 10.8893 5.10474 10.6364 6.29542C10.4639 7.10827 10.2507 7.54827 9.78758 8.04689C9.08083 8.80808 8.2648 8.92578 6.34308 9.02458L5.11091 9.088V4.92795V0.992736H6.20973C6.81409 0.992736 7.55498 1.03707 7.85609 1.09118Z"
        fill={filled ? "currentColor" : "#B6B6B6"}
      />
    </svg>
  );
}

function IconCatalog({ filled, className }) {
  return (
    <svg
      width="26"
      height="17"
      viewBox="0 0 26 17"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
      className={className}
      aria-hidden="true"
      focusable="false"
    >
      <path
        d="M15.3676 0.876953C18.7859 0.877103 21.557 3.64901 21.557 7.06738C21.5569 10.4856 18.7858 13.2567 15.3676 13.2568C11.9492 13.2568 9.17727 10.4857 9.17712 7.06738C9.17712 3.64892 11.9491 0.876953 15.3676 0.876953Z"
        stroke="currentColor"
        strokeWidth="1.75485"
      />
      <path
        d="M23.6853 16.7022C24.031 17.0418 24.5865 17.0368 24.9261 16.6911C25.2656 16.3454 25.2607 15.7899 24.915 15.4503L24.3001 16.0762L23.6853 16.7022ZM19.9236 11.7773C19.3087 12.4033 19.3087 12.4033 19.3088 12.4033C19.3088 12.4034 19.3088 12.4034 19.3088 12.4034C19.3089 12.4035 19.3091 12.4036 19.3092 12.4038C19.3095 12.4041 19.31 12.4046 19.3107 12.4052C19.312 12.4065 19.3139 12.4084 19.3164 12.4109C19.3215 12.4159 19.3291 12.4233 19.3391 12.4331C19.3591 12.4527 19.3885 12.4817 19.4267 12.5192C19.503 12.5941 19.6138 12.703 19.7522 12.8389C20.029 13.1108 20.4158 13.4908 20.8561 13.9232C21.7366 14.7881 22.8307 15.8628 23.6853 16.7022L24.3001 16.0762L24.915 15.4503C24.0604 14.6109 22.9663 13.5361 22.0858 12.6713C21.6455 12.2388 21.2587 11.8589 20.9819 11.587C20.8435 11.4511 20.7327 11.3422 20.6564 11.2672C20.6183 11.2298 20.5888 11.2008 20.5688 11.1812C20.5588 11.1714 20.5512 11.164 20.5461 11.159C20.5436 11.1564 20.5417 11.1546 20.5404 11.1533C20.5397 11.1527 20.5393 11.1522 20.5389 11.1519C20.5388 11.1517 20.5386 11.1516 20.5386 11.1515C20.5385 11.1515 20.5385 11.1514 20.5385 11.1514C20.5385 11.1514 20.5384 11.1514 19.9236 11.7773Z"
        fill={filled ? "currentColor" : "#B6B6B6"}
      />
      <path
        d="M0.890015 12.11C0.398481 12.11 1.46627e-05 12.5085 1.46627e-05 13C1.46627e-05 13.4915 0.398481 13.89 0.890015 13.89V13V12.11ZM0.890015 13V13.89H6.39001V13V12.11H0.890015V13Z"
        fill={filled ? "currentColor" : "#B6B6B6"}
      />
      <path
        d="M0.890015 6.10805C0.398481 6.10805 1.46627e-05 6.50651 1.46627e-05 6.99805C1.46627e-05 7.48958 0.398481 7.88805 0.890015 7.88805V6.99805V6.10805ZM0.890015 6.99805V7.88805H6.39001V6.99805V6.10805H0.890015V6.99805Z"
        fill={filled ? "currentColor" : "#B6B6B6"}
      />
      <path
        d="M0.890015 0.11C0.398481 0.11 1.46627e-05 0.508467 1.46627e-05 1C1.46627e-05 1.49153 0.398481 1.89 0.890015 1.89V1V0.11ZM0.890015 1V1.89H7.89001V1V0.11H0.890015V1Z"
        fill={filled ? "currentColor" : "#B6B6B6"}
      />
    </svg>
  );
}

function IconFavorites({ filled, className }) {
  return (
    <svg
      width="21"
      height="21"
      viewBox="0 0 21 21"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
      className={className}
      aria-hidden="true"
      focusable="false"
    >
      <path
        d="M10.5 5.78023C8.57243 1.25588 1.82605 1.73776 1.82605 7.5204C1.82605 13.303 10.5 18.122 10.5 18.122C10.5 18.122 19.1739 13.303 19.1739 7.5204C19.1739 1.73776 12.4275 1.25588 10.5 5.78023Z"
        stroke="currentColor"
        strokeWidth="1.78774"
        strokeLinecap="round"
        strokeLinejoin="round"
        fill={filled ? "currentColor" : "none"}
      />
    </svg>
  );
}

function IconTrash({ filled, className }) {
  const inactiveFill = "#B6B6B6";

  return (
    <svg
      width="20"
      height="19"
      viewBox="0 0 20 19"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
      className={className}
      aria-hidden="true"
      focusable="false"
    >
      <path
        d="M11.661 0C12.5886 0.000306804 13.3774 0.676911 13.5184 1.59375L14.1757 5.86719H12.4442L11.827 1.85352C11.8142 1.77184 11.7437 1.71124 11.661 1.71094H5.58093C5.47569 1.71094 5.39581 1.80673 5.41492 1.91016L6.72351 8.89062C6.81052 9.35487 6.50496 9.80219 6.04089 9.88965C5.57642 9.97674 5.12906 9.67048 5.04187 9.20605L3.73328 2.22559C3.51659 1.06882 4.40399 0 5.58093 0H11.661Z"
        fill={filled ? "currentColor" : inactiveFill}
      />
      <path
        d="M16.187 6.99609C18.0485 6.9963 19.4833 8.6389 19.2319 10.4834L18.5337 15.6045L18.4819 15.8848C18.1624 17.2636 16.929 18.2606 15.4888 18.2607H4.23779L3.97119 18.25C2.73939 18.1434 1.68888 17.3045 1.31201 16.127L1.2417 15.8701L0.0776367 10.749C-0.339561 8.9124 0.975626 7.16058 2.81299 7.00781L3.18896 8.7207H3.07373C2.20915 8.72087 1.56863 9.52406 1.76025 10.3672L2.92334 15.4873C3.0628 16.1008 3.60867 16.5361 4.23779 16.5361H15.4888C16.1624 16.536 16.7336 16.0386 16.8247 15.3711L17.5229 10.25C17.6329 9.44126 17.0032 8.72091 16.187 8.7207H8.41846C8.40895 8.64772 8.39835 8.57421 8.38232 8.50098L8.05322 6.99609H16.187Z"
        fill={filled ? "currentColor" : inactiveFill}
      />

      {filled ? null : (
        <>
          <mask id="lm-footer-trash-mask" fill="white">
            <path d="M16.187 6.99609C18.0485 6.9963 19.4833 8.6389 19.2319 10.4834L18.5337 15.6045L18.4819 15.8848C18.1624 17.2636 16.929 18.2606 15.4888 18.2607H4.23779L3.97119 18.25C2.73939 18.1434 1.68888 17.3045 1.31201 16.127L1.2417 15.8701L0.0776367 10.749C-0.339561 8.9124 0.975626 7.16058 2.81299 7.00781L3.18896 8.7207H3.07373C2.20915 8.72087 1.56863 9.52406 1.76025 10.3672L2.92334 15.4873C3.0628 16.1008 3.60867 16.5361 4.23779 16.5361H15.4888C16.1624 16.536 16.7336 16.0386 16.8247 15.3711L17.5229 10.25C17.6329 9.44126 17.0032 8.72091 16.187 8.7207H8.41846C8.40895 8.64772 8.39835 8.57421 8.38232 8.50098L8.05322 6.99609H16.187Z" />
          </mask>
          <path
            d="M16.187 6.99609L16.1872 5.28456H16.187V6.99609ZM19.2319 10.4834L20.9278 10.7146L20.9278 10.7145L19.2319 10.4834ZM18.5337 15.6045L20.2168 15.9153L20.2241 15.8757L20.2295 15.8357L18.5337 15.6045ZM18.4819 15.8848L20.1493 16.2711L20.158 16.2335L20.165 16.1956L18.4819 15.8848ZM15.4888 18.2607V19.9723H15.489L15.4888 18.2607ZM4.23779 18.2607L4.16889 19.9709L4.20333 19.9723H4.23779V18.2607ZM3.97119 18.25L3.82368 19.9552L3.86292 19.9586L3.90228 19.9602L3.97119 18.25ZM1.31201 16.127L-0.338783 16.5789L-0.329174 16.614L-0.318081 16.6486L1.31201 16.127ZM1.2417 15.8701L-0.427266 16.2495L-0.418974 16.286L-0.409096 16.322L1.2417 15.8701ZM0.0776367 10.749L-1.59138 11.1281L-1.59133 11.1284L0.0776367 10.749ZM2.81299 7.00781L4.48473 6.64087L4.16365 5.17807L2.67118 5.30216L2.81299 7.00781ZM3.18896 8.7207V10.4322H5.31693L4.86071 8.35376L3.18896 8.7207ZM3.07373 8.7207V7.00916L3.0734 7.00916L3.07373 8.7207ZM1.76025 10.3672L3.42927 9.98805L3.42923 9.98787L1.76025 10.3672ZM2.92334 15.4873L1.25432 15.8664L1.25438 15.8667L2.92334 15.4873ZM15.4888 16.5361V18.2477H15.4892L15.4888 16.5361ZM16.8247 15.3711L18.5205 15.6024L18.5206 15.6023L16.8247 15.3711ZM17.5229 10.25L19.2188 10.4812L19.2189 10.4806L17.5229 10.25ZM16.187 8.7207L16.1874 7.00916H16.187V8.7207ZM8.41846 8.7207L6.72126 8.94182L6.91544 10.4322H8.41846V8.7207ZM8.38232 8.50098L6.7103 8.86663L6.71035 8.86683L8.38232 8.50098ZM8.05322 6.99609V5.28456H5.92694L6.3812 7.36175L8.05322 6.99609ZM16.187 6.99609L16.1868 8.70763C17.0121 8.70772 17.6473 9.43609 17.5361 10.2523L19.2319 10.4834L20.9278 10.7145C21.3194 7.8417 19.085 5.28488 16.1872 5.28456L16.187 6.99609ZM19.2319 10.4834L17.5361 10.2522L16.8378 15.3733L18.5337 15.6045L20.2295 15.8357L20.9278 10.7146L19.2319 10.4834ZM18.5337 15.6045L16.8506 15.2937L16.7989 15.574L18.4819 15.8848L20.165 16.1956L20.2168 15.9153L18.5337 15.6045ZM18.4819 15.8848L16.8146 15.4984C16.6736 16.107 16.1268 16.5491 15.4886 16.5492L15.4888 18.2607L15.489 19.9723C17.7311 19.972 19.6513 18.4203 20.1493 16.2711L18.4819 15.8848ZM15.4888 18.2607V16.5492H4.23779V18.2607V19.9723H15.4888V18.2607ZM4.23779 18.2607L4.3067 16.5506L4.0401 16.5398L3.97119 18.25L3.90228 19.9602L4.16889 19.9709L4.23779 18.2607ZM3.97119 18.25L4.11871 16.5448C3.57482 16.4978 3.10869 16.1258 2.9421 15.6053L1.31201 16.127L-0.318081 16.6486C0.269066 18.4833 1.90397 19.7891 3.82368 19.9552L3.97119 18.25ZM1.31201 16.127L2.96281 15.675L2.89249 15.4182L1.2417 15.8701L-0.409096 16.322L-0.338783 16.5789L1.31201 16.127ZM1.2417 15.8701L2.91066 15.4907L1.7466 10.3697L0.0776367 10.749L-1.59133 11.1284L-0.427266 16.2495L1.2417 15.8701ZM0.0776367 10.749L1.74666 10.3699C1.56237 9.55862 2.14347 8.78092 2.9548 8.71347L2.81299 7.00781L2.67118 5.30216C-0.192218 5.54023 -2.24149 8.26618 -1.59138 11.1281L0.0776367 10.749ZM2.81299 7.00781L1.14125 7.37476L1.51722 9.08765L3.18896 8.7207L4.86071 8.35376L4.48473 6.64087L2.81299 7.00781ZM3.18896 8.7207V7.00916H3.07373V8.7207V10.4322H3.18896V8.7207ZM3.07373 8.7207L3.0734 7.00916C1.1097 7.00954 -0.343521 8.83339 0.0912765 10.7465L1.76025 10.3672L3.42923 9.98787C3.48079 10.2147 3.3086 10.4322 3.07406 10.4322L3.07373 8.7207ZM1.76025 10.3672L0.0912359 10.7463L1.25432 15.8664L2.92334 15.4873L4.59236 15.1082L3.42927 9.98805L1.76025 10.3672ZM2.92334 15.4873L1.25438 15.8667C1.57113 17.26 2.81025 18.2477 4.23779 18.2477V16.5361V14.8246C4.4071 14.8246 4.55447 14.9415 4.5923 15.1079L2.92334 15.4873ZM4.23779 16.5361V18.2477H15.4888V16.5361V14.8246H4.23779V16.5361ZM15.4888 16.5361L15.4892 18.2477C17.0161 18.2473 18.3135 17.1202 18.5205 15.6024L16.8247 15.3711L15.1289 15.1397C15.1538 14.957 15.3087 14.8246 15.4883 14.8246L15.4888 16.5361ZM16.8247 15.3711L18.5206 15.6023L19.2188 10.4812L17.5229 10.25L15.8271 10.0188L15.1289 15.1399L16.8247 15.3711ZM17.5229 10.25L19.2189 10.4806C19.4687 8.64316 18.039 7.00963 16.1874 7.00916L16.187 8.7207L16.1866 10.4322C15.9675 10.4322 15.7971 10.2394 15.827 10.0194L17.5229 10.25ZM16.187 8.7207V7.00916H8.41846V8.7207V10.4322H16.187V8.7207ZM8.41846 8.7207L10.1157 8.49958C10.1048 8.41625 10.0867 8.28304 10.0543 8.13512L8.38232 8.50098L6.71035 8.86683C6.70973 8.86403 6.71058 8.86747 6.71263 8.8803C6.71476 8.89371 6.71739 8.91209 6.72126 8.94182L8.41846 8.7207ZM8.38232 8.50098L10.0543 8.13532L9.72525 6.63044L8.05322 6.99609L6.3812 7.36175L6.7103 8.86663L8.38232 8.50098ZM8.05322 6.99609V8.70763H16.187V6.99609V5.28456H8.05322V6.99609Z"
            mask="url(#lm-footer-trash-mask)"
            fill={inactiveFill}
          />
        </>
      )}
    </svg>
  );
}

function IconProfile({ filled, className }) {
  return (
    <svg
      width="18"
      height="18"
      viewBox="0 0 18 18"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
      className={className}
      aria-hidden="true"
      focusable="false"
    >
      <path
        d="M9 11.0186C11.1222 11.0186 13.2171 11.5809 14.7539 12.4727C16.3231 13.3833 17.1119 14.5045 17.1104 15.5605V16.9141C17.1104 16.9556 17.0935 17.0027 17.0527 17.042C17.0109 17.0823 16.9473 17.1104 16.875 17.1104H1.125C1.05269 17.1104 0.989103 17.0823 0.947266 17.042C0.9065 17.0027 0.889648 16.9556 0.889648 16.9141V15.5615C0.889648 14.5044 1.6796 13.3832 3.24805 12.4727C4.78422 11.581 6.8779 11.0186 9 11.0186ZM9 0.889648C9.84923 0.88965 10.6578 1.21562 11.249 1.78613C11.8392 2.35568 12.1641 3.12177 12.1641 3.91309C12.164 4.30552 12.0841 4.69518 11.9277 5.05957C11.7713 5.42388 11.5413 5.75697 11.249 6.03906C10.9567 6.32122 10.6077 6.54677 10.2217 6.70117C9.83539 6.85559 9.41987 6.93555 9 6.93555C8.58013 6.93555 8.16462 6.85559 7.77832 6.70117C7.39228 6.54677 7.04334 6.32122 6.75098 6.03906C6.45873 5.75697 6.22868 5.42388 6.07227 5.05957C5.91587 4.69518 5.83596 4.30552 5.83594 3.91309C5.83594 3.12177 6.16083 2.35568 6.75098 1.78613C7.34219 1.21562 8.15077 0.889648 9 0.889648Z"
        stroke="currentColor"
        strokeWidth="1.78"
        strokeLinecap="round"
        strokeLinejoin="round"
        fill={filled ? "currentColor" : "none"}
      />
    </svg>
  );
}

const tabs = [
  {
    key: "home",
    href: "/",
    label: "home",
    Icon: IconHome,
  },
  {
    key: "poizon",
    href: "/poizon",
    label: "Poizon",
    Icon: IconPoizon,
  },
  {
    key: "catalog",
    href: "/catalog",
    label: "catalog",
    Icon: IconCatalog,
  },
  {
    key: "heart",
    href: "/favorites",
    label: "favorites",
    Icon: IconFavorites,
  },
  {
    key: "trash",
    href: "/trash",
    label: "trash",
    Icon: IconTrash,
    withBadge: true,
  },
  {
    key: "user",
    href: "/profile",
    label: "profile",
    Icon: IconProfile,
  },
];

function getActiveTab(pathname) {
  if (pathname === "/") return "home";
  if (pathname.startsWith("/search")) return "home";
  if (pathname.startsWith("/poizon")) return "poizon";
  if (pathname.startsWith("/catalog")) return "catalog";
  if (pathname.startsWith("/favorites")) return "heart";
  if (pathname.startsWith("/trash")) return "trash";
  if (pathname.startsWith("/profile")) return "user";
  return "";
}

export default function Footer() {
  const pathname = usePathname();
  const [cartCount, setCartCount] = useState(0);
  const rootRef = React.useRef(null);

  useEffect(() => {
    const el = rootRef.current;
    if (!el) return;

    const applyHeightVar = () => {
      const h = el.offsetHeight || 0;
      document.documentElement.style.setProperty(
        "--lm-footer-height",
        `${h}px`,
      );
    };

    applyHeightVar();

    if (typeof ResizeObserver !== "undefined") {
      const ro = new ResizeObserver(() => applyHeightVar());
      ro.observe(el);
      window.addEventListener("resize", applyHeightVar);
      return () => {
        ro.disconnect();
        window.removeEventListener("resize", applyHeightVar);
      };
    }

    window.addEventListener("resize", applyHeightVar);
    return () => window.removeEventListener("resize", applyHeightVar);
  }, []);

  useEffect(() => {
    const refresh = () => setCartCount(getCartTotalQuantityFromStorage());
    refresh();

    window.addEventListener("storage", refresh);
    window.addEventListener(CART_UPDATED_EVENT, refresh);
    document.addEventListener("visibilitychange", refresh);

    return () => {
      window.removeEventListener("storage", refresh);
      window.removeEventListener(CART_UPDATED_EVENT, refresh);
      document.removeEventListener("visibilitychange", refresh);
    };
  }, []);

  const activeTab = getActiveTab(pathname);
  const badgeText = cartCount > 99 ? "99+" : String(cartCount);

  return (
    <nav ref={rootRef} className={styles.root} aria-label="Bottom navigation">
      <div className={styles.inner}>
        {tabs.map((tab) => {
          const isActive = tab.key === activeTab;
          const Icon = tab.Icon;

          return (
            <Link
              key={tab.key}
              href={tab.href}
              className={cn(styles.link, isActive && styles.linkActive)}
              aria-current={isActive ? "page" : undefined}
              aria-label={tab.label}
            >
              <span className={styles.iconWrap}>
                <Icon
                  filled={isActive}
                  className={cn(
                    styles.icon,
                    isActive ? styles.iconActive : styles.iconMuted,
                  )}
                />

                {tab.withBadge && cartCount > 0 ? (
                  <span className={styles.badge}>{badgeText}</span>
                ) : null}
              </span>
            </Link>
          );
        })}
      </div>
    </nav>
  );
}
